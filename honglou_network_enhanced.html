import json
from pyvis.network import Network

def create_optimized_network():
    # 读取数据
    with open('baoyu_network2 (1).json', 'r', encoding='utf-8') as f:
        data = json.load(f)

    # 创建网络图 - 增加画布尺寸
    net = Network(height="1000px", width="1200px", bgcolor="#f8f9fa")

    # 添加节点 - 大幅减小节点尺寸
    node_data = data['graphDataset']['nodeData']

    for node_id, attributes in node_data.items():
        label = attributes.get('label', node_id)
        degree = attributes.get('degree', 1)

        # 优化节点大小计算 - 大幅减小基础尺寸
        size = max(8, min(25, 5 + degree * 0.08))  # 从 0.5 降到 0.08

        # 根据角色类型设置颜色
        if degree > 100:  # 核心角色
            color = {'background': '#e74c3c', 'border': '#c0392b'}
        elif degree > 30:  # 重要角色
            color = {'background': '#3498db', 'border': '#2980b9'}
        else:  # 次要角色
            color = {'background': '#2ecc71', 'border': '#27ae60'}

        net.add_node(
            node_id,
            label=label,
            size=size,  # 使用优化后的大小
            color=color,
            font={'size': 12, 'face': 'Microsoft YaHei'},  # 减小字体
            title=f"{label}\n连接数: {degree}"
        )

    # 添加边 - 不需要特别调整，物理引擎会自动处理
    edge_data = data['graphDataset']['edgeData']
    full_graph_edges = data['graphDataset']['fullGraph']['edges']

    for edge in full_graph_edges:
        source = edge['source']
        target = edge['target']
        edge_key = edge['key']

        if edge_key in edge_data:
            weight = edge_data[edge_key].get('weight', 1)
            width = max(0.5, min(3, weight * 0.3))  # 减小边宽度

            net.add_edge(source, target, width=width)

    # 关键优化：调整物理引擎参数，增加节点间距
    net.set_options("""
    var options = {
      "physics": {
        "enabled": true,
        "stabilization": {"iterations": 150},
        "repulsion": {
          "centralGravity": 0.05,      // 减小中心引力
          "springLength": 300,         // 增加弹簧长度（重要！）
          "springConstant": 0.01,      // 减小弹性系数
          "nodeDistance": 200,         // 增加节点距离
          "damping": 0.09
        }
      },
      "interaction": {
        "hover": true,
        "tooltipDelay": 200
      }
    }
    """)

    return net

# 生成优化后的网页
network = create_optimized_network()
network.save_graph('honglou_optimized.html')
print("优化版网页已生成: honglou_optimized.html")